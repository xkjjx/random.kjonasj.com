<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digit Recognition - Model Comparison</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
</head>
<body>
    <div class="page-wide">
        <a href="./" class="nav-link">Back to main page</a>
        <h1>Digit Recognition</h1>
        <p class="subtitle">Compare predictions across multiple models</p>

        <div class="main-layout">
            <div class="draw-section">
                <canvas id="drawCanvas" width="28" height="28"></canvas>
                <div class="canvas-label">28×28 pixels (scaled 10× for display)</div>

                <div class="buttons">
                    <button id="recognizeBtn" disabled>Recognize All</button>
                    <button id="clearBtn">Clear</button>
                </div>

                <div class="model-links">
                    <p>For more info, see individual pages:</p>
                    <ul>
                        <li><a href="simplev1.html">Simple v1</a></li>
                        <li><a href="cnnv1.html">CNN v1</a></li>
                        <li><a href="cnnv2.html">CNN v2</a></li>
                    </ul>
                </div>
            </div>

            <div class="models-section">
                <div class="model-results">
                    <!-- Simple v1 -->
                    <div class="model-card" id="simplev1-card">
                        <div class="model-header">
                            <a class="model-name" href="simplev1.html">Simple MLP</a>
                            <span class="model-badge outlined simple">Simple v1</span>
                            <span class="model-status loading" id="simplev1-status">Loading...</span>
                        </div>
                        <div class="prediction-row">
                            <span class="prediction-value compact" id="simplev1-prediction">?</span>
                            <span class="confidence" id="simplev1-confidence"></span>
                        </div>
                        <div class="probabilities compact" id="simplev1-probs"></div>
                    </div>

                    <!-- CNN v1 -->
                    <div class="model-card" id="cnnv1-card">
                        <div class="model-header">
                            <a class="model-name" href="cnnv1.html">CNN</a>
                            <span class="model-badge outlined cnn">CNN v1</span>
                            <span class="model-status loading" id="cnnv1-status">Loading...</span>
                        </div>
                        <div class="prediction-row">
                            <span class="prediction-value compact" id="cnnv1-prediction">?</span>
                            <span class="confidence" id="cnnv1-confidence"></span>
                        </div>
                        <div class="probabilities compact" id="cnnv1-probs"></div>
                    </div>

                    <!-- CNN v2 -->
                    <div class="model-card" id="cnnv2-card">
                        <div class="model-header">
                            <a class="model-name" href="cnnv2.html">CNN</a>
                            <span class="model-badge outlined cnn">CNN v2</span>
                            <span class="model-status loading" id="cnnv2-status">Loading...</span>
                        </div>
                        <div class="prediction-row">
                            <span class="prediction-value compact" id="cnnv2-prediction">?</span>
                            <span class="confidence" id="cnnv2-confidence"></span>
                        </div>
                        <div class="probabilities compact" id="cnnv2-probs"></div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // ============================================================
            // Model Configuration
            // ============================================================

            const models = {
                simplev1: {
                    path: 'assets/simplev1/model.onnx',
                    session: null,
                    // Simple MLP uses 3D input: [batch, height, width]
                    tensorShape: [1, 28, 28]
                },
                cnnv1: {
                    path: 'assets/cnnv1/model.onnx',
                    session: null,
                    // CNN uses 4D input: [batch, channels, height, width]
                    tensorShape: [1, 1, 28, 28]
                },
                cnnv2: {
                    path: 'assets/cnnv2/model.onnx',
                    session: null,
                    // CNN uses 4D input: [batch, channels, height, width]
                    tensorShape: [1, 1, 28, 28]
                }
            };

            // ============================================================
            // Utility Functions
            // ============================================================

            function softmax(x) {
                const maxVal = Math.max(...x);
                const exps = x.map(v => Math.exp(v - maxVal));
                const sum = exps.reduce((a, b) => a + b, 0);
                return exps.map(v => v / sum);
            }

            function updateStatus(modelId, status, text) {
                const el = document.getElementById(`${modelId}-status`);
                el.className = `model-status ${status}`;
                el.textContent = text;
            }

            function updateProbabilityBars(containerId, probs) {
                const container = document.getElementById(containerId);

                if (!probs || probs.length === 0) {
                    container.innerHTML = Array.from({length: 10}, (_, i) => `
                        <div class="prob-row">
                            <span class="digit">${i}</span>
                            <div class="bar-bg"><div class="bar" style="width: 0%"></div></div>
                            <span class="pct">-</span>
                        </div>
                    `).join('');
                    return;
                }

                const maxIdx = probs.indexOf(Math.max(...probs));

                container.innerHTML = probs.map((p, i) => `
                    <div class="prob-row">
                        <span class="digit">${i}</span>
                        <div class="bar-bg"><div class="bar ${i === maxIdx ? 'top' : ''}" style="width: ${(p * 100).toFixed(1)}%"></div></div>
                        <span class="pct">${(p * 100).toFixed(1)}%</span>
                    </div>
                `).join('');
            }

            // ============================================================
            // Canvas Drawing
            // ============================================================

            const canvas = document.getElementById('drawCanvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });

            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            function clearCanvas() {
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Reset all predictions
                for (const modelId of Object.keys(models)) {
                    document.getElementById(`${modelId}-prediction`).textContent = '?';
                    document.getElementById(`${modelId}-confidence`).textContent = '';
                    updateProbabilityBars(`${modelId}-probs`, []);
                }
            }

            clearCanvas();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            function getPos(e) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;

                if (e.touches) {
                    return {
                        x: (e.touches[0].clientX - rect.left) * scaleX,
                        y: (e.touches[0].clientY - rect.top) * scaleY
                    };
                }
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY
                };
            }

            function startDrawing(e) {
                isDrawing = true;
                const pos = getPos(e);
                lastX = pos.x;
                lastY = pos.y;
                ctx.beginPath();
                ctx.arc(lastX, lastY, ctx.lineWidth / 2, 0, Math.PI * 2);
                ctx.fillStyle = '#fff';
                ctx.fill();
            }

            function draw(e) {
                if (!isDrawing) return;
                e.preventDefault();

                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();

                lastX = pos.x;
                lastY = pos.y;
            }

            function stopDrawing() {
                isDrawing = false;
            }

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);

            // ============================================================
            // Image Processing & Inference
            // ============================================================

            function getImageData() {
                const imageData = ctx.getImageData(0, 0, 28, 28);
                const pixels = imageData.data;

                const input = new Float32Array(784);
                for (let i = 0; i < 784; i++) {
                    input[i] = pixels[i * 4] / 255.0;
                }

                return input;
            }

            async function runInference(modelId, inputData) {
                const model = models[modelId];
                if (!model.session) return null;

                const tensor = new ort.Tensor('float32', inputData, model.tensorShape);
                const results = await model.session.run({ image: tensor });
                return Array.from(results.logits.data);
            }

            async function recognizeAll() {
                const input = getImageData();

                // Run inference on all loaded models sequentially
                // (ONNX Runtime Web has issues with concurrent session access)
                for (const modelId of Object.keys(models)) {
                    if (!models[modelId].session) continue;

                    try {
                        const logits = await runInference(modelId, input);
                        if (!logits) continue;

                        const probs = softmax(logits);

                        let maxIdx = 0;
                        let maxVal = probs[0];
                        for (let i = 1; i < probs.length; i++) {
                            if (probs[i] > maxVal) {
                                maxVal = probs[i];
                                maxIdx = i;
                            }
                        }

                        document.getElementById(`${modelId}-prediction`).textContent = maxIdx;
                        document.getElementById(`${modelId}-confidence`).textContent =
                            `Confidence: ${(maxVal * 100).toFixed(1)}%`;
                        updateProbabilityBars(`${modelId}-probs`, probs);
                    } catch (err) {
                        console.error(`Inference error for ${modelId}:`, err);
                    }
                }
            }

            // ============================================================
            // Initialization
            // ============================================================

            document.getElementById('recognizeBtn').addEventListener('click', recognizeAll);
            document.getElementById('clearBtn').addEventListener('click', clearCanvas);

            // Initialize probability bars
            for (const modelId of Object.keys(models)) {
                updateProbabilityBars(`${modelId}-probs`, []);
            }

            // Load all models
            let loadedCount = 0;
            const totalModels = Object.keys(models).length;

            function checkAllLoaded() {
                if (loadedCount === totalModels) {
                    document.getElementById('recognizeBtn').disabled = false;
                }
            }

            for (const [modelId, model] of Object.entries(models)) {
                ort.InferenceSession.create(model.path)
                    .then(session => {
                        model.session = session;
                        updateStatus(modelId, 'ready', 'Ready');
                        loadedCount++;
                        checkAllLoaded();
                    })
                    .catch(err => {
                        console.error(`Failed to load ${modelId}:`, err);
                        updateStatus(modelId, 'error', 'Failed to load');
                        loadedCount++;
                        checkAllLoaded();
                    });
            }
        </script>
    </div>
</body>
</html>
